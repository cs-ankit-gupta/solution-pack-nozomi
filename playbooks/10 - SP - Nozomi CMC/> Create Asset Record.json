{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "> Create Asset Record",
    "aliasName": null,
    "tag": null,
    "description": "This PB will create Asset Record and fetch CVEs from Nozomi and correlate Asset with CVEs, ICS Advisory and KEV Alert",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "assetRecord",
        "alertIRI",
        "parentAssetIRI"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/566483c2-686f-4c7d-b8df-eb51583b1814",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/7efa71c6-7516-496c-84fd-495c2eb0bec4",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "record": "{{vars.input.params.assetRecord}}",
                "useMockOutput": "{{globalVars.Demo_mode}}"
            },
            "status": null,
            "top": "165",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "392700bd-044b-4b79-a029-91349eff4a82"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get Picklist IRI",
            "description": null,
            "arguments": {
                "categoryIRI": "{{\"AssetCategory\" | picklist(vars.record.type, \"@id\")}}",
                "protocolIRI": "{% set iri = [] %}{% for prot in vars.record.protocols %}{% set _ = iri.append(\"AssetProtocol\" | picklist(prot, \"@id\")) %}{% endfor %}{{iri}}"
            },
            "status": null,
            "top": "300",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "6f97dacc-d7e2-4e39-9e06-ccba99ba48ce"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    }
                }
            },
            "status": null,
            "top": "30",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "7efa71c6-7516-496c-84fd-495c2eb0bec4"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Assets",
            "description": null,
            "arguments": {
                "resource": {
                    "ip": "{{vars.record.ip | join(', ') }}",
                    "name": "{{vars.record.product_name}}",
                    "level": "{{\"AssetLevel\" | picklist('Level ' + vars.record.level, \"@id\")}}",
                    "__link": {
                        "recordTags": [
                            "\/api\/3\/tags\/Nozomi"
                        ]
                    },
                    "assets": "{{vars.input.params.parentAssetIRI}}",
                    "vendor": "{{vars.record.mac_vendor | join(', ') }}",
                    "category": "{{vars.categoryIRI}}",
                    "firmware": "{{vars.record.os_or_firmware}}",
                    "hostname": "{{vars.record.name}}",
                    "protocol": "{% set data = [] %}{% for item in vars.protocolIRI | unique %}{% if item is none %}{% set _ = vars.protocolIRI.remove(item) %}{% else %}{% set _ = data.append(item) %}{% endif %}{% endfor %}{{data}}",
                    "__replace": "true",
                    "deviceUid": "{{vars.record.device_id}}",
                    "macAddress": "{{vars.record.mac_address | join(', ') }}",
                    "description": "<table>\n{% if vars.record.os != \"\" %}\n<tr>\n<th>Operating System<\/th>\n<td>{{vars.record.os}}<\/td>\n<\/tr>\n{% endif %}\n{% if vars.categoryIRI is none %}\n<tr>\n<th>Asset Category<\/th>\n<td>{{vars.record.type}}<\/td>\n<\/tr>\n{% endif %}\n<tr>\n<th>Roles<\/th>\n<td>{{vars.record.roles | join(', ') }}<\/td>\n<\/tr>\n{% if 'Undefined' not in vars.record.zones %}\n<tr>\n<th>Zones<\/th>\n<td>{{vars.record.zones | join(', ') }}<\/td>\n<\/tr>\n{% endif %}\n<tr>\n<th>Protocol<\/th>\n<td>{{vars.record.protocols | join(', ') }}<\/td>\n<\/tr>\n<tr>\n<th>Last Activity Time<\/th>\n<td>{{arrow.get(vars.record.last_activity_time | int).to(\"UTC\").format(\"YYYY-MM-DD HH:mm:ss ZZ\")}}<\/td>\n<\/tr>\n<\/table>",
                    "registrationDate": "{{vars.record.created_at}}"
                },
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/assets",
                "__recommend": [],
                "fieldOperation": {
                    "protocol": "Overwrite",
                    "recordTags": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "435",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "f32e6a71-6388-4692-b58d-697831d25af3"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get Correlated Record Of CVEs",
            "description": null,
            "arguments": {
                "query": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": [
                        {
                            "type": "primitive",
                            "field": "uuid",
                            "value": "{{vars.item.uuid}}",
                            "operator": "eq",
                            "_operator": "eq"
                        }
                    ],
                    "__selectFields": [
                        "iCSAdvisories",
                        "kEVAlerts"
                    ]
                },
                "module": "c_v_es?$limit=100000&$relationships=true&$fsr_max_relation_count=100",
                "for_each": {
                    "item": "{{vars.cVE}}",
                    "parallel": false,
                    "condition": ""
                },
                "checkboxFields": true,
                "step_variables": {
                    "kevAlert": "{{vars.steps.Get_Correlated_Record_Of_CVEs | flatten | json_query('[*][kEVAlerts][][]') | unique}}",
                    "iCSAdvisory": "{{vars.steps.Get_Correlated_Record_Of_CVEs | flatten | json_query('[*][iCSAdvisories][][]') | unique}}"
                }
            },
            "status": null,
            "top": "705",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928770",
            "group": null,
            "uuid": "a4dd9491-1135-482e-b5e3-3d05e03c7b5b"
        },
        {
            "@type": "WorkflowStep",
            "name": "Update Asset With CVEs ICS Advisory and KEV Alert",
            "description": null,
            "arguments": {
                "resource": {
                    "__link": {
                        "cVEs": "{{vars.cVE | json_query('[*][\"@id\"][]')}}",
                        "kEVAlerts": "{{vars.kevAlert | json_query('[*][\"@id\"][]') }}",
                        "iCSAdvisories": "{{vars.iCSAdvisory | json_query('[*][\"@id\"][]') }}"
                    }
                },
                "operation": "Append",
                "collection": "{{vars.steps.Create_Assets['@id']}}",
                "__recommend": [],
                "collectionType": "\/api\/3\/assets",
                "fieldOperation": {
                    "protocol": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "975",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "b6c4e2e3-a19a-4131-8fc6-86da986feb27"
        },
        {
            "@type": "WorkflowStep",
            "name": "Update Alert With CVEs And ICS Advisory",
            "description": null,
            "arguments": {
                "resource": {
                    "__link": {
                        "cVEs": "{{vars.cVE | json_query('[*][\"@id\"][]') }}",
                        "iCSAdvisories": "{{vars.iCSAdvisory | json_query('[*][\"@id\"][]')}}"
                    }
                },
                "operation": "Append",
                "collection": "{{vars.input.params.alertIRI}}",
                "__recommend": [],
                "collectionType": "\/api\/3\/alerts",
                "fieldOperation": [],
                "step_variables": []
            },
            "status": null,
            "top": "840",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "319cfcce-a7ea-469c-a264-1c5ab3c49c9c"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get CVEs By Asset Id",
            "description": null,
            "arguments": {
                "arguments": {
                    "vendor": "",
                    "assetId": "{{vars.record.id}}",
                    "vendorTag": "{{vars.record.vendor}}",
                    "applianceId": "{{vars.sourceData['appliance_id']}}"
                },
                "apply_async": false,
                "step_variables": {
                    "cVE": "{{vars.steps.Get_CVEs_By_Asset_Id['cVEResult']}}"
                },
                "pass_parent_env": false,
                "pass_input_record": false,
                "workflowReference": "\/api\/3\/workflows\/5a4da070-db21-4fc6-a5a0-6d561939c6d9"
            },
            "status": null,
            "top": "570",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/74932bdc-b8b6-4d24-88c4-1a4dfbc524f3",
            "group": null,
            "uuid": "a24b2406-e11c-4409-bc97-3ed1a475ed0a"
        },
        {
            "@type": "WorkflowStep",
            "name": "Output",
            "description": null,
            "arguments": {
                "cVE": "{{vars.cVE}}",
                "asset": "{{vars.steps.Create_Assets['@id']}}",
                "assetIRI": "{{vars.steps.Create_Assets['@id']}}",
                "kevAlert": "{{vars.kevAlert}}",
                "iCSAdvisory": "{{vars.iCSAdvisory}}"
            },
            "status": null,
            "top": "1110",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "87a5e047-8c65-47bf-8c01-795ea124b8b0"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Create Assets -> Get CVEs",
            "targetStep": "\/api\/3\/workflow_steps\/a24b2406-e11c-4409-bc97-3ed1a475ed0a",
            "sourceStep": "\/api\/3\/workflow_steps\/f32e6a71-6388-4692-b58d-697831d25af3",
            "label": null,
            "isExecuted": false,
            "uuid": "0a9a5e36-4a10-4a51-a10b-57b667b31453"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get CVEs -> Get Correlated Record Of CVEs",
            "targetStep": "\/api\/3\/workflow_steps\/a4dd9491-1135-482e-b5e3-3d05e03c7b5b",
            "sourceStep": "\/api\/3\/workflow_steps\/a24b2406-e11c-4409-bc97-3ed1a475ed0a",
            "label": null,
            "isExecuted": false,
            "uuid": "2481a4ab-09ee-4332-8b74-86df84a836af"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update Asset With CVEs ICS Advisory and KEV Alert -> Output",
            "targetStep": "\/api\/3\/workflow_steps\/87a5e047-8c65-47bf-8c01-795ea124b8b0",
            "sourceStep": "\/api\/3\/workflow_steps\/b6c4e2e3-a19a-4131-8fc6-86da986feb27",
            "label": null,
            "isExecuted": false,
            "uuid": "4cf843da-2a1a-4f56-8a79-a549d8039bf3"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get Correlated Record Of CVEs -> Update Alert With CVEs And ICS Advisory",
            "targetStep": "\/api\/3\/workflow_steps\/319cfcce-a7ea-469c-a264-1c5ab3c49c9c",
            "sourceStep": "\/api\/3\/workflow_steps\/a4dd9491-1135-482e-b5e3-3d05e03c7b5b",
            "label": null,
            "isExecuted": false,
            "uuid": "756bb7bf-5c31-41f4-a68d-e1b8c5f2062f"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get Values -> Create",
            "targetStep": "\/api\/3\/workflow_steps\/f32e6a71-6388-4692-b58d-697831d25af3",
            "sourceStep": "\/api\/3\/workflow_steps\/6f97dacc-d7e2-4e39-9e06-ccba99ba48ce",
            "label": null,
            "isExecuted": false,
            "uuid": "89f27d7c-31c1-4a30-9a3a-8a85e6876946"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update Alert With CVEs And ICS Advisory -> Update Asset With ICS Advisory And KEV Alert",
            "targetStep": "\/api\/3\/workflow_steps\/b6c4e2e3-a19a-4131-8fc6-86da986feb27",
            "sourceStep": "\/api\/3\/workflow_steps\/319cfcce-a7ea-469c-a264-1c5ab3c49c9c",
            "label": null,
            "isExecuted": false,
            "uuid": "af387347-cfb0-46c5-88af-7066f9d9df5f"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Get Values",
            "targetStep": "\/api\/3\/workflow_steps\/6f97dacc-d7e2-4e39-9e06-ccba99ba48ce",
            "sourceStep": "\/api\/3\/workflow_steps\/392700bd-044b-4b79-a029-91349eff4a82",
            "label": null,
            "isExecuted": false,
            "uuid": "e28b3bc3-aef2-4831-bed1-dd2d518971b5"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/392700bd-044b-4b79-a029-91349eff4a82",
            "sourceStep": "\/api\/3\/workflow_steps\/7efa71c6-7516-496c-84fd-495c2eb0bec4",
            "label": null,
            "isExecuted": false,
            "uuid": "e942ddc5-af2b-46ff-b29c-2c03c682769f"
        }
    ],
    "groups": [],
    "priority": "\/api\/3\/picklists\/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
    "uuid": "9eb98a74-ab4e-4c7b-8ea9-5577ff7eb8ac",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "Assets",
        "Referenced",
        "Nozomi",
        "ICS Advisory",
        "CVE",
        "KEV",
        "Alert"
    ]
}